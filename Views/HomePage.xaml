<Page x:Class="Deno.Views.HomePage"
      x:Name="HomePageRoot"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:local="clr-namespace:Deno.Behaviors"
      xmlns:converters="clr-namespace:Deno.Converters"
      mc:Ignorable="d">

	<!-- Background Gradient -->
	<Page.Background>
		<LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
			<GradientStop Color="White" Offset="0"/>
			<GradientStop Color="White" Offset="1"/>
		</LinearGradientBrush>
	</Page.Background>

	<Page.Resources>
		<!-- Boolean to Visibility Converter -->
		<BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

		<!-- Inverted Boolean Converter for IsEnabled -->
		<local:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
		<converters:ButtonContentMultiConverter x:Key="ButtonContentMultiConverter" />
		<!-- Card Style -->
		<Style x:Key="CardStyle" TargetType="Border">
			<Setter Property="Background" Value="White"/>
			<Setter Property="CornerRadius" Value="10"/>
			<Setter Property="Padding" Value="2"/>
			<Setter Property="Margin" Value="1"/>
		</Style>


        <Storyboard x:Key="BlinkStoryboard" RepeatBehavior="1:0:0">
            <ColorAnimation
        Storyboard.TargetName="HelpButton"
        Storyboard.TargetProperty="(Button.Background).(SolidColorBrush.Color)"
        From="LightGreen"
        To="Green"
        Duration="0:0:2"     
                AutoReverse="True"
        RepeatBehavior="Forever" />
        </Storyboard>

        <!-- Modern Button Style -->
		<Style x:Key="ModernButton" TargetType="Button">
			<Setter Property="Background" Value="#4f46e5"/>
			<Setter Property="Foreground" Value="White"/>
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="Padding" Value="16,8"/>
			<Setter Property="FontSize" Value="14"/>
			<Setter Property="FontWeight" Value="SemiBold"/>
			<Setter Property="Cursor" Value="Hand"/>
			<Setter Property="Template">
				<Setter.Value>
					<ControlTemplate TargetType="Button">
						<Border Background="{TemplateBinding Background}"
                                CornerRadius="6"
                                Padding="{TemplateBinding Padding}">
							<ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
						</Border>
						<ControlTemplate.Triggers>
							<Trigger Property="IsMouseOver" Value="True">
								<Setter Property="Background" Value="#3730a3"/>
							</Trigger>
							<Trigger Property="IsPressed" Value="True">
								<Setter Property="Background" Value="#312e81"/>
							</Trigger>
						</ControlTemplate.Triggers>
					</ControlTemplate>
				</Setter.Value>
			</Setter>
		</Style>

		<!-- Danger Button -->
		<Style x:Key="DangerButton" TargetType="Button" BasedOn="{StaticResource ModernButton}">
			<Setter Property="Background" Value="#ef4444"/>
			<Style.Triggers>
				<Trigger Property="IsMouseOver" Value="True">
					<Setter Property="Background" Value="#dc2626"/>
				</Trigger>
				<Trigger Property="IsPressed" Value="True">
					<Setter Property="Background" Value="#b91c1c"/>
				</Trigger>
			</Style.Triggers>
		</Style>

		<!-- Success Button -->
		<Style x:Key="SuccessButton" TargetType="Button" BasedOn="{StaticResource ModernButton}">
			<Setter Property="Background" Value="#10b981"/>
			<Style.Triggers>
				<Trigger Property="IsMouseOver" Value="True">
					<Setter Property="Background" Value="#059669"/>
				</Trigger>
				<Trigger Property="IsPressed" Value="True">
					<Setter Property="Background" Value="#047857"/>
				</Trigger>
			</Style.Triggers>
		</Style>

		<!-- Modern TextBox Style -->
		<Style x:Key="ModernTextBox" TargetType="TextBox">
			<Setter Property="Height" Value="36"/>
			<Setter Property="Padding" Value="8,4"/>
			<Setter Property="BorderBrush" Value="#d1d5db"/>
			<Setter Property="BorderThickness" Value="1"/>
			<Setter Property="Background" Value="White"/>
			<Setter Property="Foreground" Value="Black"/>
			<Setter Property="CaretBrush" Value="Black"/>
			<Setter Property="FontSize" Value="14"/>
			<Setter Property="Template">
				<Setter.Value>
					<ControlTemplate TargetType="TextBox">
						<Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="6"
                                Padding="{TemplateBinding Padding}">
							<ScrollViewer x:Name="PART_ContentHost" />
						</Border>
						<ControlTemplate.Triggers>
							<Trigger Property="IsFocused" Value="True">
								<Setter Property="BorderBrush" Value="#4f46e5"/>
							</Trigger>
						</ControlTemplate.Triggers>
					</ControlTemplate>
				</Setter.Value>
			</Setter>
		</Style>

		<!-- Loading Icon Style -->
		<Style x:Key="LoadingIconStyle" TargetType="TextBlock">
			<Setter Property="FontSize" Value="24"/>
			<Setter Property="Foreground" Value="#4f46e5"/>
			<Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
			<Setter Property="RenderTransform">
				<Setter.Value>
					<RotateTransform/>
				</Setter.Value>
			</Setter>
			<Style.Triggers>
				<Trigger Property="Visibility" Value="Visible">
					<Trigger.EnterActions>
						<BeginStoryboard>
							<Storyboard>
								<DoubleAnimation Storyboard.TargetProperty="(RenderTransform).(RotateTransform.Angle)"
                                                 From="0" To="360" Duration="0:0:1" RepeatBehavior="Forever"/>
							</Storyboard>
						</BeginStoryboard>
					</Trigger.EnterActions>
				</Trigger>
			</Style.Triggers>
		</Style>

		<!-- Main Grid Style with Blur Effect -->
		<Style x:Key="MainGridStyle" TargetType="Grid">
			<Setter Property="Effect">
				<Setter.Value>
					<BlurEffect Radius="0" KernelType="Gaussian"/>
				</Setter.Value>
			</Setter>
			<Style.Triggers>
				<DataTrigger Binding="{Binding IsLoading, ElementName=HomePageRoot}" Value="True">
					<Setter Property="Effect">
						<Setter.Value>
							<BlurEffect Radius="5" KernelType="Gaussian"/>
						</Setter.Value>
					</Setter>
				</DataTrigger>
			</Style.Triggers>
		</Style>
	</Page.Resources>

	<Grid>
		<!-- Main Content Grid (with blur effect) -->
		<Grid Margin="0"
              IsEnabled="{Binding IsLoading, ElementName=HomePageRoot, Converter={StaticResource InverseBooleanConverter}}"
              Style="{StaticResource MainGridStyle}">
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<!-- Header -->
				<RowDefinition Height="*"/>
				<!-- Main Content -->
				<RowDefinition Height="Auto"/>
				<!-- Footer -->
			</Grid.RowDefinitions>

			<!-- HEADER -->
            <Border Grid.Row="0" Background="White" Padding="0" CornerRadius="0" Margin="0">
                <DockPanel LastChildFill="False">
                    <StackPanel DockPanel.Dock="Left" Orientation="Horizontal">
                        <Ellipse Width="8" Height="8" Fill="#10b981" Margin="0,0,6,0"/>
                        <TextBlock Text="{Binding WelcomeText, ElementName=HomePageRoot}"
                       FontSize="18"
                       FontWeight="Bold"
                       Foreground="#1f2937"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" Margin="0">
                        <!-- Help Us Button -->
                        <Button x:Name="HelpButton"
                Content="Support 📩"
                Height="40"
                Width="120"
                Padding="12,6"
                                 Click="OpenPopup_Click"
                Margin="10"
                  Style="{StaticResource DangerButton}"               
                Background="LightGreen">
                            <Button.Triggers>
                                <!-- Start blinking automatically when page loads -->
                                <EventTrigger RoutedEvent="Button.Loaded">
                                    <BeginStoryboard Storyboard="{StaticResource BlinkStoryboard}" />
                                </EventTrigger>
                            </Button.Triggers>
                        </Button>
                        <!-- 8-pixel gap to the right -->
                        <!-- Logout Button (last, furthest to the right) -->
                        <Button Content="Logout ➜]"
                    Command="{Binding LogoutCommand, ElementName=HomePageRoot}"
                    Style="{StaticResource DangerButton}"
                    Height="40"
                    Padding="12,6"
                    Margin="0"/>
                        <!-- Explicitly no right margin -->
                    </StackPanel>
                </DockPanel>
            </Border>
            <!-- MAIN CONTENT -->
			<ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
				<UniformGrid Columns="2" HorizontalAlignment="Stretch">

                    <!-- Notes Card -->
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
                                <Border Background="#ddd6fe" CornerRadius="8" Width="40" Height="40" Margin="0,0,12,0">
                                    <TextBlock Text="💵" FontSize="20" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <StackPanel>
                                    <TextBlock Text="Notes"
                               FontSize="20"
                               FontWeight="Bold"
                               Foreground="#1f2937"/>
                                    <TextBlock Text="Enter note quantities"
                               FontSize="14"
                               Foreground="#6b7280"/>
                                </StackPanel>
                            </StackPanel>


                            <ItemsControl ItemsSource="{Binding NoteViewModels}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#f8fafc" CornerRadius="1" Padding="4" Margin="0,0,0,4">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="60"/>
                                                    <ColumnDefinition Width="2*"/>
                                                    <ColumnDefinition Width="140"/>
                                                </Grid.ColumnDefinitions>

                                                <Border Background="#ede9fe" CornerRadius="6" Padding="8,4">
                                                    <TextBlock Text="{Binding Denomination, StringFormat='{}{0}'}"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center"
                                               FontSize="12"
                                               FontWeight="SemiBold"
                                               Foreground="#6b21a8"/>
                                                </Border>

                                                <TextBox Grid.Column="1"
                                         Text="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}"
                                         Margin="12,0"
                                         GotFocus="TextBox_GotFocus">
                                                    <TextBox.Style>
                                                        <Style TargetType="TextBox" BasedOn="{StaticResource ModernTextBox}">
                                                            <Setter Property="local:NumericValidationBehavior.IsEnabled" Value="True"/>
                                                            <Setter Property="IsEnabled" Value="{Binding DataContext.EditMod, ElementName=HomePageRoot, Converter={StaticResource InverseBooleanConverter}}"/>
                                                            <Style.Triggers>
                                                                <Trigger Property="IsEnabled" Value="False">
                                                                    <Setter Property="Background" Value="#e5e7eb"/>
                                                                    <Setter Property="Foreground" Value="#6b7280"/>
                                                                </Trigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBox.Style>
                                                </TextBox>

                                                <Border Grid.Column="2" Background="#dcfce7" CornerRadius="6" Padding="8,4">
                                                    <TextBlock Text="{Binding Total, StringFormat='{}{0}'}"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center"
                                               FontWeight="Bold"
                                               FontSize="14"
                                               Foreground="#166534"/>
                                                </Border>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <!--  <local:VirtualNumpad Grid.Row="1" Margin="10" /> -->
                        </StackPanel>
                    </Border>

                    <!-- Coins Card -->
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
                                <Border Background="#fef3c7" CornerRadius="8" Width="40" Height="40" Margin="0,0,12,0">
                                    <TextBlock Text="🪙" FontSize="20" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <StackPanel>
                                    <TextBlock Text="Coins"
                           FontSize="20"
                           FontWeight="Bold"
                           Foreground="#1f2937"/>
                                    <TextBlock Text="Enter coin quantities"
                           FontSize="14"
                           Foreground="#6b7280"/>
                                </StackPanel>
                            </StackPanel>

                            <StackPanel>

                                

                                <!-- Coins List -->
                                <ItemsControl x:Name="CoinsItemsControl" 
									   ItemsSource="{Binding CoinViewModels}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#f8fafc"
												CornerRadius="1"
												Padding="4"
												Margin="0,0,0,4">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="60"/>
                                                        <ColumnDefinition Width="2*"/>
                                                        <ColumnDefinition Width="140"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Denomination -->
                                                    <Border Background="#e0e7ff" CornerRadius="6" Padding="6,3">
                                                        <TextBlock Text="{Binding Denomination, StringFormat='{}{0:F3}'}"
														   VerticalAlignment="Center"
														   HorizontalAlignment="Center"
														   FontSize="12"
														   FontWeight="SemiBold"
														   Foreground="#3730a3"/>
													</Border>

                                                    <!-- Quantity input -->
                                                    <TextBox x:Name="CoinQuantityTextBox"
													 Grid.Column="1"
													 Text="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}"
													 Margin="8,0"
													 GotFocus="TextBox_GotFocus">
                                                        <TextBox.Style>
                                                            <Style TargetType="TextBox" BasedOn="{StaticResource ModernTextBox}">
                                                                <Setter Property="local:NumericValidationBehavior.IsEnabled" Value="True"/>
                                                                <Setter Property="IsEnabled" Value="{Binding DataContext.EditMod, ElementName=HomePageRoot, Converter={StaticResource InverseBooleanConverter}}"/>
                                                                <Style.Triggers>
                                                                    <Trigger Property="IsEnabled" Value="False">
                                                                        <Setter Property="Background" Value="#e5e7eb"/>
                                                                        <Setter Property="Foreground" Value="#6b7280"/>
                                                                    </Trigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBox.Style>
                                                    </TextBox>

                                                    <!-- Total -->
                                                    <Border Grid.Column="2" Background="#dcfce7" CornerRadius="6" Padding="6,3">
                                                        <TextBlock Text="{Binding Total, StringFormat='{}{0}'}"
													   VerticalAlignment="Center"
													   HorizontalAlignment="Center"
													   FontWeight="Bold"
													   FontSize="14"
													   Foreground="#166534"/>
                                                    </Border>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <!-- Initial Amount Row -->
                                <Border Background="#f8fafc"
									CornerRadius="1"
									Padding="8"
									Margin="0,0,0,4">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="60"/>
                                            <ColumnDefinition Width="2*"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Label -->
                                        <Border Background="#e0e7ff" CornerRadius="6" Padding="6,3">
                                            <TextBlock Text="Opn Amt"
										   VerticalAlignment="Center"
										   HorizontalAlignment="Center"
										   FontSize="12"
										   FontWeight="SemiBold"
										   Foreground="#3730a3"/>
                                        </Border>

                                        <!-- Input for Initial Amount -->
                                        <TextBox Grid.Column="1"
											Margin="8,0"
											Text="{Binding InitialAmount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
														<TextBox.Style>
															<Style TargetType="TextBox" BasedOn="{StaticResource ModernTextBox}">
																<Setter Property="local:NumericValidationBehavior.IsEnabled" Value="True"/>
																<Setter Property="IsEnabled" 
															Value="{Binding DataContext.EditMod, ElementName=HomePageRoot, Converter={StaticResource InverseBooleanConverter}}"/>

                                                    <!-- Red border -->
                                                    <Setter Property="BorderBrush" Value="#FF5600"/>
                                                    <Setter Property="BorderThickness" Value="1"/>

                                                    <Style.Triggers>
                                                        <Trigger Property="IsEnabled" Value="False">
                                                            <Setter Property="Background" Value="#e5e7eb"/>
                                                            <Setter Property="Foreground" Value="#6b7280"/>
                                                            <Setter Property="BorderBrush" Value="#FF5600"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBox.Style>
                                        </TextBox>



                                    </Grid>
                                </Border>
                            </StackPanel>

                            <!-- 
                            <TextBox 
                                Text="{Binding AllQuantitiesString, Mode=OneWay}" 
								FontSize="14"
								IsReadOnly="True"
								AcceptsReturn="True"
								TextWrapping="Wrap"
								VerticalScrollBarVisibility="Auto -->

                        </StackPanel>
                    </Border>

                
				</UniformGrid>
			</ScrollViewer>

			<!-- FOOTER -->
			<Border Grid.Row="2" Background="White" Padding="8" Margin="0" CornerRadius="0">
				<Grid>
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<!-- Totals -->

					<StackPanel Grid.Column="0" HorizontalAlignment="Center">
						<TextBlock Text="Notes Total" FontSize="12" Foreground="#6b21a8" FontWeight="SemiBold"/>
						<TextBlock Text="{Binding NoteTotal, StringFormat='{}{0:F3}'}"
                                   FontSize="16" FontWeight="Bold" Foreground="#6b21a8"/>
					</StackPanel>
                    
					<StackPanel Grid.Column="1" HorizontalAlignment="Center">
						<TextBlock Text="Coins Total" FontSize="12" Foreground="#92400e" FontWeight="SemiBold"/>
						<TextBlock Text="{Binding CoinTotal, StringFormat='{}{0:F3}'}"
                                   FontSize="16" FontWeight="Bold" Foreground="#92400e"/>
					</StackPanel>

					<StackPanel Grid.Column="2" HorizontalAlignment="Center">
						<TextBlock Text="Grand Total" FontSize="12" Foreground="#166534" FontWeight="SemiBold"/>
						<TextBlock Text="{Binding GrandTotal, StringFormat='{}{0:F3}'}"
                                   FontSize="20" FontWeight="Bold" Foreground="#166534"/>
					</StackPanel>
                    <!-- Buttons -->
					<Button Content="Clear All"
                            Command="{Binding ResetCommand}"
                            Grid.Column="3"
                            Margin="16,0,8,0"
                            Padding="16,8">
						<Button.Style>
							<Style TargetType="Button" BasedOn="{StaticResource ModernButton}">
								<Setter Property="Background" Value="#6b7280"/>
								<Style.Triggers>
									<Trigger Property="IsMouseOver" Value="True">
										<Setter Property="Background" Value="#4b5563"/>
									</Trigger>
									<Trigger Property="IsPressed" Value="True">
										<Setter Property="Background" Value="#374151"/>
									</Trigger>

								</Style.Triggers>
                                
                                
                                
							</Style>
						</Button.Style>
					</Button>

					<Button Command="{Binding PostToApiCommand}"
                            CommandParameter="{Binding DataContext.UpdatingRecordId, RelativeSource={RelativeSource AncestorType=Page}}"
                            Style="{StaticResource SuccessButton}"
                            Grid.Column="4"
                            Margin="8,0,0,0"
                            Padding="24,8">
						<Button.Content>
							<TextBlock>
								<TextBlock.Text>
									<MultiBinding Converter="{StaticResource ButtonContentMultiConverter}">
										<Binding Path="UpdatingRecord" />
										<Binding Path="EditMod" />
									</MultiBinding>
								</TextBlock.Text>
							</TextBlock>
						</Button.Content>
					</Button>
				</Grid>
			</Border>
		</Grid>

		<!-- Loading Overlay (outside the blurred grid) -->
		<Grid Background="#00000033"
              Visibility="{Binding IsLoading, ElementName=HomePageRoot, Converter={StaticResource BooleanToVisibilityConverter}}">
			<StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
				<TextBlock Text="⌛"
                           Style="{StaticResource LoadingIconStyle}"
                           Width="40" Height="40"/>
				<TextBlock Text="Loading..."
                           FontSize="14"
                           Foreground="#4f46e5"
                           Margin="0,8,0,0"
                           HorizontalAlignment="Center"/>
			</StackPanel>
		</Grid>
	</Grid>
</Page>